
name: Deploy Smoke Test (VPS + Private GHCR)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-24.04
    steps:
      - name: SSH into VPS and verify private GHCR pull
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: VPS_APP_DIR,GHCR_PULL_USER,GHCR_PULL_TOKEN
          script: |
            set -euo pipefail

            echo "== Host info =="
            whoami
            hostname
            uptime
            docker --version
            docker compose version

            echo "== Private GHCR pull test (ephemeral Docker config) =="
            export DOCKER_CONFIG="$(mktemp -d)"

            if [[ -z "${GHCR_PULL_USER:-}" || -z "${GHCR_PULL_TOKEN:-}" ]]; then
              echo "ERROR: GHCR_PULL_USER or GHCR_PULL_TOKEN missing in GitHub Secrets." >&2
              exit 1
            fi

            echo "${GHCR_PULL_TOKEN}" | docker login ghcr.io -u "${GHCR_PULL_USER}" --password-stdin
            docker pull ghcr.io/sagacic-tim/amigos_unite_api:main
            docker logout ghcr.io || true

            rm -rf "${DOCKER_CONFIG}"
            unset DOCKER_CONFIG

            echo "== Optional: compose validation if present =="
            APP_DIR="${VPS_APP_DIR:-/opt/amigos_unite_api}"
            if [[ -f "${APP_DIR}/docker-compose.yml" ]]; then
              cd "${APP_DIR}"
              docker compose config >/dev/null
              docker compose config --services
            else
              echo "No docker-compose.yml found at ${APP_DIR}; skipping compose validation."
            fi
        env:
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          GHCR_PULL_USER: ${{ secrets.GHCR_PULL_USER }}
          GHCR_PULL_TOKEN: ${{ secrets.GHCR_PULL_TOKEN }}
